# 診断設問 画像アップロード機能 仕様書

## 概要

診断の各設問に画像を追加できる機能を実装する。画像は1設問あたり1枚まで登録可能で、画像なしでも設問の登録は可能とする。

## 機能要件

### 基本仕様

| 項目 | 仕様 |
|------|------|
| 画像枚数 | 1設問あたり最大1枚 |
| 必須/任意 | 任意（画像なしでも設問登録可能） |
| 対応形式 | JPEG/JPG, PNG, WebP, GIF |
| 最大ファイルサイズ | 5MB |
| 保存先 | `/public/uploads/diagnoses/{filename}` |
| 画像表示位置 | 設問テキストの下、選択肢の上 |

### 管理画面での操作

1. **画像アップロード**
   - 設問編集エリアに画像アップロードボタンを追加
   - ドラッグ&ドロップまたはファイル選択でアップロード
   - アップロード中はローディング表示
   - アップロード完了後、プレビュー表示

2. **画像削除**
   - プレビュー画像に削除ボタンを表示
   - 削除時は確認なしで即時削除（画像URLをnullに設定）

3. **画像差し替え**
   - 既存画像がある場合、新しい画像をアップロードすると上書き

### ユーザー向け診断画面

- 設問に画像がある場合、設問テキストの下に画像を表示
- レスポンシブ対応（モバイルでは幅100%、PCでは最大幅500px程度）
- 画像クリックで拡大表示（オプション）

## データモデル変更

### Question型の拡張

```typescript
// /src/data/diagnosis-types.ts

export interface Question {
  id: number;
  text: string;
  imageUrl?: string | null;  // 追加: 設問画像URL
  choices: {
    text: string;
    score: number;
  }[];
}
```

### データベース

- `DiagnosisType.questions` は既にJson型のため、スキーマ変更不要
- 既存データとの互換性維持（`imageUrl`がundefinedでも動作）

## API変更

### 画像アップロードAPI（既存拡張）

**エンドポイント:** `POST /api/upload`

**変更内容:**
- `folder`パラメータに`diagnoses`を追加

```typescript
// 許可フォルダに追加
const allowedFolders = ["clinic", "channels", "diagnoses"];
```

### 診断CRUD API

既存のAPIはそのまま利用可能（Jsonフィールドのため）

- `POST /api/admin/diagnoses` - 新規作成
- `PUT /api/admin/diagnoses/[id]` - 更新
- `GET /api/admin/diagnoses/[id]` - 取得

## 実装対象ファイル

### 変更が必要なファイル

| ファイル | 変更内容 |
|----------|----------|
| `/src/data/diagnosis-types.ts` | Question型にimageUrl追加 |
| `/src/components/admin/diagnosis-form.tsx` | 画像アップロードUI追加 |
| `/src/components/diagnosis/question-card.tsx` | 画像表示追加 |
| `/src/app/api/upload/route.ts` | diagnoses フォルダ対応追加 |

### 新規作成ファイル

| ファイル | 用途 |
|----------|------|
| `/src/components/admin/question-image-upload.tsx` | 設問画像アップロードコンポーネント |

## UI/UXデザイン

### 管理画面（設問編集）

```
┌─────────────────────────────────────────────┐
│ 設問 1                              [削除] │
├─────────────────────────────────────────────┤
│ 設問文                                      │
│ ┌─────────────────────────────────────────┐ │
│ │ 歯磨きは1日何回していますか？           │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 設問画像（任意）                            │
│ ┌─────────────────────────────────────────┐ │
│ │  ┌───────────┐                          │ │
│ │  │   画像    │  [削除]                  │ │
│ │  │ プレビュー │                          │ │
│ │  └───────────┘                          │ │
│ │  または                                  │ │
│ │  [📷 画像をアップロード]                 │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 選択肢                                      │
│ ┌─────────────────────────────────────────┐ │
│ │ 選択肢1: [1回] スコア: [1]    [削除]    │ │
│ │ 選択肢2: [2回] スコア: [2]    [削除]    │ │
│ │ 選択肢3: [3回以上] スコア: [3]  [削除]  │ │
│ │ [+ 選択肢を追加]                         │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

### ユーザー向け診断画面

```
┌─────────────────────────────────────────────┐
│           質問 3 / 10                       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                             │
│ 以下の画像のような症状はありますか？         │
│                                             │
│         ┌─────────────────────┐            │
│         │                     │            │
│         │   設問に関連する    │            │
│         │     参考画像        │            │
│         │                     │            │
│         └─────────────────────┘            │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ ○ はい、よくある                        │ │
│ ├─────────────────────────────────────────┤ │
│ │ ○ たまにある                            │ │
│ ├─────────────────────────────────────────┤ │
│ │ ○ いいえ、ない                          │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│        [戻る]           [次へ]              │
└─────────────────────────────────────────────┘
```

## 実装ステップ

### Phase 1: データモデル・API対応

1. `Question`型に`imageUrl`フィールドを追加
2. アップロードAPIに`diagnoses`フォルダ対応を追加

### Phase 2: 管理画面実装

1. 画像アップロードコンポーネント作成
2. `diagnosis-form.tsx`に画像アップロードUIを統合
3. 画像削除機能の実装

### Phase 3: ユーザー向け画面実装

1. `question-card.tsx`に画像表示を追加
2. レスポンシブ対応
3. 画像拡大表示（任意）

## 注意事項

### 既存データとの互換性

- 既存の設問データには`imageUrl`フィールドが存在しない
- フロントエンドでは`imageUrl`がundefined/nullの場合は画像を表示しない
- 既存データの移行作業は不要

### 画像ファイルの管理

- 設問削除時の画像ファイル削除は行わない（簡易実装）
- 将来的にはストレージ管理機能の追加を検討

### セキュリティ

- ファイルタイプのバリデーション（既存実装を利用）
- ファイルサイズ制限（5MB、既存実装を利用）
- ファイル名のサニタイズ（既存実装を利用）

## 工数見積もり

| Phase | 作業内容 | 詳細 |
|-------|----------|------|
| Phase 1 | データモデル・API対応 | 型定義追加、API拡張 |
| Phase 2 | 管理画面実装 | アップロードUI、プレビュー、削除 |
| Phase 3 | ユーザー画面実装 | 画像表示、レスポンシブ対応 |
