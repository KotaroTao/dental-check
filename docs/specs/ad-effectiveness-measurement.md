# 広告効果測定機能 仕様書

## 概要

QRコードごとに広告費用と掲載期間を入力し、CPA（Cost Per Acquisition）などの広告効果指標を自動計算・表示する機能。

## 機能要件

### 1. 入力項目（QRコードごと）

| 項目 | フィールド名 | 型 | 必須 | 説明 |
|------|-------------|-----|------|------|
| 広告費用 | `adBudget` | Int | - | このQRコードにかけた費用（円） |
| 掲載開始日 | `adStartDate` | DateTime | - | 広告掲載の開始日 |
| 掲載終了日 | `adEndDate` | DateTime | - | 広告掲載の終了日 |
| 掲載場所メモ | `adPlacement` | String | - | どこに設置したか（自由記述） |

### 2. 自動計算される指標

#### コスト指標
| 指標 | 計算式 | 説明 |
|------|--------|------|
| CPA（読み込み単価） | 広告費 ÷ QR読み込み数 | 1回読み込んでもらうコスト |
| CPD（診断完了単価） | 広告費 ÷ 診断完了数 | 1件診断完了のコスト |
| CPC（CTAクリック単価） | 広告費 ÷ CTAクリック数 | 1件アクション獲得のコスト |
| 日割りコスト | 広告費 ÷ 掲載日数 | 1日あたりのコスト |

#### ファネル指標
| 指標 | 計算式 | 説明 |
|------|--------|------|
| 診断完了率 | 診断完了数 ÷ QR読み込み数 × 100 | 読み込み後に最後まで診断した割合 |
| CTA転換率 | CTAクリック数 ÷ 診断完了数 × 100 | 診断後に行動した割合 |
| 総合転換率 | CTAクリック数 ÷ QR読み込み数 × 100 | 読み込みから行動までの全体転換率 |

### 3. 表示場所

1. **QRコード詳細ページ** `/dashboard/channels/[id]`
   - 広告費用設定セクション
   - 効果測定カード

2. **ダッシュボードトップ** `/dashboard`
   - QRコード比較表（効果測定指標付き）

## データモデル変更

### Channelモデルに追加

```prisma
model Channel {
  // 既存フィールド
  // ...

  // 広告効果測定用フィールド（新規追加）
  adBudget      Int?       @map("ad_budget")        // 広告費用（円）
  adStartDate   DateTime?  @map("ad_start_date")    // 掲載開始日
  adEndDate     DateTime?  @map("ad_end_date")      // 掲載終了日
  adPlacement   String?    @map("ad_placement")     // 掲載場所メモ
}
```

## API設計

### GET `/api/dashboard/channels/[id]/stats`

QRコードごとの効果測定データを取得

**レスポンス**:
```json
{
  "channel": {
    "id": "uuid",
    "name": "駅前看板",
    "adBudget": 50000,
    "adStartDate": "2025-12-01T00:00:00Z",
    "adEndDate": "2025-12-31T23:59:59Z",
    "adPlacement": "JR西宮駅 北口看板"
  },
  "metrics": {
    "qrScans": 500,
    "diagnosisCompletions": 380,
    "ctaClicks": 68,
    "completionRate": 76.0,
    "ctaRate": 17.9,
    "overallConversionRate": 13.6
  },
  "costMetrics": {
    "cpa": 100,           // 読み込み単価
    "cpd": 132,           // 診断完了単価
    "cpc": 735,           // CTAクリック単価
    "dailyCost": 1613,    // 日割りコスト
    "daysRunning": 31     // 掲載日数
  },
  "period": {
    "from": "2025-12-01T00:00:00Z",
    "to": "2025-12-31T23:59:59Z"
  }
}
```

### PATCH `/api/dashboard/channels/[id]`

広告費用情報を更新（既存のchannel更新APIを拡張）

**リクエストボディ**:
```json
{
  "adBudget": 50000,
  "adStartDate": "2025-12-01",
  "adEndDate": "2025-12-31",
  "adPlacement": "JR西宮駅 北口看板"
}
```

## UI設計

### QRコード詳細ページ

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                              │
├─────────────────────────────────────────────────────┤
│ [QRコード名]                          [編集] [有効] │
├─────────────────────────────────────────────────────┤
│                                                     │
│ ┌─ 広告設定 ────────────────────────────────────┐  │
│ │ 広告費用: [¥50,000    ]                       │  │
│ │ 掲載期間: [2025/12/01] 〜 [2025/12/31]        │  │
│ │ 掲載場所: [JR西宮駅 北口看板              ]   │  │
│ │                                    [保存]     │  │
│ └───────────────────────────────────────────────┘  │
│                                                     │
│ ┌─ 広告効果測定 ────────────────────────────────┐  │
│ │                                               │  │
│ │  読み込み  →  診断完了  →  CTAクリック       │  │
│ │    500件  →   380件   →    68件              │  │
│ │         76.0%       17.9%                     │  │
│ │                                               │  │
│ │ ┌─────────┬─────────┬─────────┬─────────┐    │  │
│ │ │   CPA   │   CPD   │   CPC   │ 日割り  │    │  │
│ │ │  ¥100   │  ¥132   │  ¥735   │ ¥1,613  │    │  │
│ │ │読み込み │診断完了 │ CTA    │  /日    │    │  │
│ │ └─────────┴─────────┴─────────┴─────────┘    │  │
│ └───────────────────────────────────────────────┘  │
│                                                     │
│ [QRコード表示...]                                   │
└─────────────────────────────────────────────────────┘
```

### 効果測定が未設定の場合

```
┌─ 広告効果測定 ────────────────────────────────────┐
│                                                   │
│  💡 広告費用を入力すると、CPA等の効果測定指標が  │
│     自動計算されます                              │
│                                                   │
│  読み込み: 500件 | 診断完了: 380件 | CTA: 68件    │
│                                                   │
└───────────────────────────────────────────────────┘
```

## 実装フェーズ

### Phase 1: データモデル・API（0.5日）

1. Prismaスキーマに広告費用フィールド追加
2. マイグレーション実行
3. Channel更新APIに広告費用フィールド対応追加
4. 効果測定データ取得API実装

### Phase 2: フロントエンド（1日）

1. QRコード詳細ページに広告設定フォーム追加
2. 効果測定カード表示コンポーネント作成
3. ファネル表示（読み込み→診断完了→CTA）

## 関連ファイル

| ファイル | 変更内容 |
|----------|----------|
| `/prisma/schema.prisma` | Channelに広告費用フィールド追加 |
| `/src/app/api/dashboard/channels/[id]/route.ts` | 更新APIに広告費用対応 |
| `/src/app/api/dashboard/channels/[id]/stats/route.ts` | 新規作成（効果測定API） |
| `/src/app/dashboard/channels/[id]/page.tsx` | 広告設定・効果測定UI追加 |
| `/src/components/dashboard/ad-metrics-card.tsx` | 新規作成（効果測定カード） |
