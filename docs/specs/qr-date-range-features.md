# QRコード効果測定 期間管理・比較機能 仕様書

## 概要

QRコードの効果測定における期間管理の改善と、複数QRコード間での効果比較機能を追加する。

## 背景

現在の効果測定機能では以下の課題がある：
- 掲載終了日に開始日より前の日付を設定できてしまう
- 一度設定した日付をリセットする手段がない
- 期間未設定時の効果測定の対象期間が曖昧
- ダッシュボードで各QRコードの掲載期間が確認できない
- 複数QRコードの効果を比較する機能がない

## 機能要件

### 1. 掲載終了日のバリデーション

#### 動作仕様
- 掲載終了日は掲載開始日以降の日付のみ選択可能とする
- 掲載開始日が未設定の場合、掲載終了日は制限なく設定可能
- 掲載開始日を変更した際、終了日が開始日より前の場合は終了日をクリアする

#### 実装箇所
- `/src/app/dashboard/channels/[id]/edit/page.tsx`

#### UIの挙動
```
[掲載開始日] 2024/01/15 を選択
↓
[掲載終了日] の日付選択で 2024/01/15 より前の日付は非活性化（選択不可）
```

### 2. 日付リセットボタン

#### 動作仕様
- 掲載開始日・終了日それぞれにリセットボタンを配置
- リセットボタン押下で該当フィールドをnull（未設定）に戻す
- 開始日をリセットした場合、終了日のバリデーション制限を解除

#### UI配置
```
掲載開始日: [2024/01/15] [×リセット]
掲載終了日: [2024/03/31] [×リセット]
```

#### 実装箇所
- `/src/app/dashboard/channels/[id]/edit/page.tsx`

### 3. 期間による効果測定フィルタリング

#### 動作仕様

| 開始日 | 終了日 | 効果測定対象期間 |
|--------|--------|-----------------|
| 未設定 | 未設定 | 全期間（チャネル作成日から現在まで） |
| 設定済 | 未設定 | 開始日から現在まで |
| 未設定 | 設定済 | 作成日から終了日まで |
| 設定済 | 設定済 | 開始日から終了日まで |

#### 集計ロジック
- DiagnosisSession.createdAtを対象期間でフィルタリング
- アクセス数、診断完了数、CTAクリック数すべてに適用
- CPA/CPD/CPC計算は対象期間内のデータのみで算出

#### 実装箇所
- `/src/app/api/dashboard/channel-stats/route.ts`
- `/src/app/api/dashboard/stats/route.ts`

### 4. ダッシュボードへの期間表示

#### 動作仕様
- 各QRコードカードに掲載期間を表示
- 期間未設定の場合は「無期限」と表示

#### 表示フォーマット

| パターン | 表示例 |
|---------|--------|
| 両方未設定 | 無期限 |
| 開始のみ | 2024/01/15〜 |
| 終了のみ | 〜2024/03/31 |
| 両方設定 | 2024/01/15〜2024/03/31 |

#### 表示位置
- QRコードカード内、効果測定バッジの下に配置
- 小さいフォントでグレー系の色

#### 実装箇所
- `/src/app/dashboard/page.tsx`

### 5. QRコード効果比較機能

#### 動作仕様
- ダッシュボードに「効果比較」ボタンを追加
- 最大5つのQRコードを選択して比較可能
- 比較モーダルまたは比較ページで以下を並列表示

#### 比較項目

| 項目 | 説明 |
|------|------|
| 掲載期間 | 開始日〜終了日 |
| アクセス数 | QR読み込み総数 |
| 診断完了数 | 診断を最後まで完了した数 |
| 完了率 | 診断完了数 / アクセス数 × 100 |
| CTAクリック数 | 各種CTAボタンのクリック総数 |
| CTA率 | CTAクリック数 / 診断完了数 × 100 |
| 広告費用 | 設定された広告費用 |
| CPA | 広告費用 / アクセス数 |
| CPD | 広告費用 / 診断完了数 |

#### 比較UI

```
┌─────────────────────────────────────────────────────────────┐
│ QRコード効果比較                                    [×閉じる] │
├─────────────────────────────────────────────────────────────┤
│                │ チラシA    │ チラシB    │ Web広告    │
├─────────────────────────────────────────────────────────────┤
│ 掲載期間        │ 1/15〜3/31  │ 2/1〜2/28   │ 無期限      │
│ アクセス数      │ 1,234      │ 567        │ 2,345      │
│ 診断完了数      │ 890        │ 432        │ 1,567      │
│ 完了率         │ 72.1%      │ 76.2%      │ 66.8%      │
│ CTAクリック     │ 234        │ 156        │ 432        │
│ CTA率          │ 26.3%      │ 36.1%      │ 27.6%      │
│ 広告費用        │ ¥50,000    │ ¥30,000    │ ¥100,000   │
│ CPA            │ ¥40        │ ¥53        │ ¥43        │
│ CPD            │ ¥56        │ ¥69        │ ¥64        │
└─────────────────────────────────────────────────────────────┘
```

#### チャート表示（オプション）
- 棒グラフで各指標を視覚的に比較
- 複数指標の切り替え表示

#### 実装箇所
- `/src/app/dashboard/page.tsx` - 比較ボタン追加
- `/src/components/dashboard/comparison-modal.tsx` - 新規作成
- `/src/app/api/dashboard/compare/route.ts` - 新規作成

## 技術仕様

### API変更

#### GET /api/dashboard/channel-stats

リクエストパラメータ追加：
```typescript
interface ChannelStatsParams {
  channelId: string;
  // 以下は期間フィルタリング用（オプション、nullの場合は全期間）
  startDate?: string;  // ISO 8601形式
  endDate?: string;    // ISO 8601形式
}
```

レスポンス変更：
```typescript
interface ChannelStatsResponse {
  // 既存フィールド...
  accessCount: number;
  completedCount: number;
  // ...

  // 追加フィールド
  periodStart: string | null;  // 効果測定開始日
  periodEnd: string | null;    // 効果測定終了日
  periodLabel: string;         // 表示用ラベル（"2024/01/15〜2024/03/31" or "無期限"）
}
```

#### POST /api/dashboard/compare（新規）

リクエスト：
```typescript
interface CompareRequest {
  channelIds: string[];  // 最大5件
}
```

レスポンス：
```typescript
interface CompareResponse {
  channels: Array<{
    id: string;
    name: string;
    periodLabel: string;
    accessCount: number;
    completedCount: number;
    completionRate: number;
    ctaCount: number;
    ctaRate: number;
    adBudget: number | null;
    cpa: number | null;
    cpd: number | null;
  }>;
}
```

### データベース

スキーマ変更は不要（既存の`adStartDate`、`adEndDate`フィールドを使用）

### フロントエンド

#### 新規コンポーネント
- `ComparisonModal` - 比較モーダル
- `DateResetButton` - 日付リセットボタン

#### 更新コンポーネント
- チャネル編集フォーム - バリデーション追加、リセットボタン追加
- ダッシュボードカード - 期間表示追加
- ダッシュボードヘッダー - 比較ボタン追加

## 画面遷移

```
ダッシュボード
├── QRコードカード
│   └── 期間表示（無期限 / 2024/01/15〜2024/03/31）
├── [効果比較] ボタン
│   └── 比較モーダル
│       ├── QRコード選択（チェックボックス、最大5件）
│       └── 比較結果テーブル
└── QRコード編集
    └── 効果測定セクション
        ├── 掲載開始日 + リセットボタン
        └── 掲載終了日 + リセットボタン（開始日以降のみ選択可）
```

## 非機能要件

### パフォーマンス
- 比較API: 5件のQRコード比較で500ms以内
- ダッシュボード: 期間表示追加による追加クエリなし（既存データを利用）

### 互換性
- 既存データ: 期間未設定のQRコードは「無期限」として動作
- 後方互換: 既存APIのレスポンス形式を維持（フィールド追加のみ）

## 実装順序

1. **Phase 1: 日付バリデーション・リセット**
   - 編集画面のフォーム改修
   - 終了日のバリデーション追加
   - リセットボタン実装

2. **Phase 2: 期間フィルタリング**
   - channel-stats APIの期間フィルタ実装
   - 期間ラベル生成ロジック追加

3. **Phase 3: ダッシュボード期間表示**
   - QRコードカードへの期間表示追加
   - 無期限ラベル表示

4. **Phase 4: 比較機能**
   - 比較APIの新規作成
   - 比較モーダルコンポーネント作成
   - ダッシュボードへの比較ボタン追加

## テスト項目

### 日付バリデーション
- [ ] 開始日より前の終了日が選択できないこと
- [ ] 開始日変更時に終了日が不正になった場合クリアされること
- [ ] 開始日未設定時は終了日に制限がないこと

### リセット機能
- [ ] リセットボタンで日付がクリアされること
- [ ] リセット後に保存が正常に完了すること

### 期間フィルタリング
- [ ] 期間未設定時に全期間のデータが集計されること
- [ ] 期間設定時に対象期間のみが集計されること
- [ ] CPA/CPD/CPCが対象期間で正しく計算されること

### ダッシュボード表示
- [ ] 期間未設定QRコードに「無期限」が表示されること
- [ ] 期間設定QRコードに正しい期間が表示されること

### 比較機能
- [ ] 2〜5件のQRコードが選択できること
- [ ] 1件または6件以上で比較ボタンが無効化されること
- [ ] 比較結果が正しく表示されること
