# QRコード別診断結果閲覧機能 仕様書

## 概要

各QRコード（チャンネル）に紐づく診断結果を一覧表示し、詳細を確認できる機能。
歯科医院が患者の診断傾向を把握し、マーケティングやサービス改善に活用できる。

## 現状

- ダッシュボードには全体統計（アクセス数、完了数、エリア分布等）が表示される
- 診断履歴APIは存在するが、QRコード別の結果詳細画面は未実装
- 個々の診断結果（スコア、結果カテゴリ等）の閲覧手段がない

## 機能要件

### 1. QRコード詳細ページに「診断結果」タブを追加

**場所**: `/dashboard/channels/[id]`

| タブ | 内容 |
|------|------|
| QRコード | 既存のQRコード表示・ダウンロード |
| 診断結果 | 新規追加 - 診断結果一覧 |

### 2. 診断結果一覧の表示項目

| 項目 | 説明 | ソート |
|------|------|--------|
| 日時 | 診断完了日時 | ✅ |
| 年齢 | 利用者の年齢 | ✅ |
| 性別 | 男性/女性/その他 | ✅ |
| 地域 | 都道府県・市区町村・町名 | - |
| スコア | 診断の合計スコア | ✅ |
| 結果 | 診断結果カテゴリ（例: お口年齢+5歳） | ✅ |
| CTAクリック | 予約ボタン等をクリックしたか | ✅ |

### 3. フィルター機能

| フィルター | 選択肢 |
|------------|--------|
| 期間 | 今日 / 1週間 / 1ヶ月 / カスタム |
| 性別 | 全て / 男性 / 女性 / その他 |
| 年齢層 | 全て / ~19歳 / 20-29歳 / 30-39歳 / 40-49歳 / 50-59歳 / 60歳~ |
| 結果カテゴリ | 全て / 各カテゴリ |
| CTAクリック | 全て / あり / なし |

### 4. 集計サマリー

一覧の上部に表示：

```
診断完了: 125件 | 平均スコア: 42.5点 | CTAクリック率: 18.4%
```

### 5. CSVエクスポート

スタンダードプラン以上で利用可能：

- 表示中のフィルター条件でエクスポート
- ファイル名: `診断結果_{QRコード名}_{日付}.csv`

## データモデル

### 既存テーブル（DiagnosisSession）

```prisma
model DiagnosisSession {
  id              String    @id @default(uuid())
  clinicId        String?   @map("clinic_id")
  channelId       String?   @map("channel_id")
  diagnosisTypeId String?   @map("diagnosis_type_id")

  // ユーザー情報
  userAge         Int?      @map("user_age")
  userGender      String?   @map("user_gender")

  // 位置情報
  region          String?   // 都道府県
  city            String?   // 市区町村
  town            String?   // 町丁目

  // 診断結果
  totalScore      Int?      @map("total_score")
  resultCategory  String?   @map("result_category")
  resultTitle     String?   @map("result_title")

  // タイムスタンプ
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")

  isDemo          Boolean   @default(false) @map("is_demo")
}
```

### 確認事項

現在のDiagnosisSessionに以下のフィールドが存在するか確認が必要：

- [ ] `totalScore` - 診断スコア合計
- [ ] `resultCategory` - 結果カテゴリ
- [ ] `resultTitle` - 結果タイトル

存在しない場合はマイグレーションが必要。

## API設計

### GET `/api/dashboard/channels/[id]/results`

**リクエストパラメータ**:

| パラメータ | 型 | 必須 | 説明 |
|------------|-----|------|------|
| period | string | - | today/week/month/custom |
| startDate | string | - | カスタム期間の開始日 |
| endDate | string | - | カスタム期間の終了日 |
| gender | string | - | male/female/other |
| ageRange | string | - | ~19/20-29/30-39/40-49/50-59/60~ |
| resultCategory | string | - | 結果カテゴリ |
| hasCta | string | - | true/false |
| sortBy | string | - | createdAt/score/age |
| sortOrder | string | - | asc/desc |
| offset | number | - | ページネーション |
| limit | number | - | 取得件数（デフォルト50） |

**レスポンス**:

```json
{
  "results": [
    {
      "id": "uuid",
      "createdAt": "2025-12-31T10:00:00Z",
      "userAge": 35,
      "userGender": "female",
      "region": "兵庫県",
      "city": "西宮市",
      "town": "松園町7丁目",
      "totalScore": 45,
      "resultCategory": "good",
      "resultTitle": "お口年齢 実年齢-5歳",
      "hasCta": true
    }
  ],
  "summary": {
    "total": 125,
    "averageScore": 42.5,
    "ctaRate": 18.4,
    "genderDistribution": {
      "male": 45,
      "female": 72,
      "other": 8
    },
    "ageDistribution": {
      "~19": 5,
      "20-29": 22,
      "30-39": 38,
      "40-49": 35,
      "50-59": 18,
      "60~": 7
    }
  },
  "pagination": {
    "total": 125,
    "offset": 0,
    "limit": 50,
    "hasMore": true
  }
}
```

### GET `/api/dashboard/channels/[id]/results/export`

CSVエクスポート用エンドポイント（スタンダードプラン以上）

## UI設計

### ページレイアウト

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                              │
├─────────────────────────────────────────────────────┤
│ [QRコード名]                          [編集] [有効] │
│ 診断タイプ: お口年齢診断                           │
├─────────────────────────────────────────────────────┤
│ [QRコード] [診断結果]  ← タブ切り替え              │
├─────────────────────────────────────────────────────┤
│                                                     │
│ ┌─ フィルター ─────────────────────────────────┐   │
│ │ 期間: [1ヶ月 ▼] 性別: [全て ▼] 年齢: [全て ▼]│   │
│ └───────────────────────────────────────────────┘   │
│                                                     │
│ 診断完了: 125件 | 平均スコア: 42.5点 | CTA率: 18.4% │
│                                        [CSVエクスポート] │
│                                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 日時      │ 年齢 │ 性別 │ 地域   │ スコア │ 結果  │ │
│ ├───────────┼──────┼──────┼────────┼────────┼───────┤ │
│ │ 12/31 10:00│ 35  │ 女性 │ 西宮市 │ 45点  │ -5歳  │ │
│ │ 12/31 09:30│ 42  │ 男性 │ 大阪市 │ 38点  │ +3歳  │ │
│ │ ...       │     │     │       │       │       │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│              [もっと見る]                           │
└─────────────────────────────────────────────────────┘
```

### 結果詳細モーダル（行クリック時）

```
┌─────────────────────────────────────────┐
│ 診断結果詳細                      [×]  │
├─────────────────────────────────────────┤
│ 診断日時: 2025/12/31 10:00             │
│                                         │
│ ■ 利用者情報                           │
│   年齢: 35歳                           │
│   性別: 女性                           │
│   地域: 兵庫県西宮市松園町7丁目         │
│                                         │
│ ■ 診断結果                             │
│   スコア: 45点                         │
│   結果: お口年齢 実年齢-5歳            │
│   カテゴリ: good                       │
│                                         │
│ ■ アクション                           │
│   CTAクリック: あり（予約ボタン）       │
│   クリック日時: 2025/12/31 10:02       │
└─────────────────────────────────────────┘
```

## 実装フェーズ

### Phase 1: 基本機能（必須）

1. DiagnosisSessionテーブルの確認・マイグレーション
2. 診断完了時にスコア・結果を保存するよう修正
3. API実装 `/api/dashboard/channels/[id]/results`
4. 診断結果一覧ページ実装

### Phase 2: 拡張機能

1. フィルター機能
2. ソート機能
3. 集計サマリー表示
4. 結果詳細モーダル

### Phase 3: エクスポート機能

1. CSVエクスポートAPI
2. プラン制限チェック

## プライバシー考慮

- 個人を特定できる情報（名前、電話番号等）は保存・表示しない
- 位置情報は町丁目レベルまで（GPS座標は保存しない）
- データは医院管理者のみアクセス可能

## 関連ファイル

| ファイル | 説明 |
|----------|------|
| `/src/app/dashboard/channels/[id]/page.tsx` | QRコード詳細ページ（修正対象） |
| `/src/app/api/dashboard/history/route.ts` | 既存履歴API（参考） |
| `/src/components/diagnosis/result-card.tsx` | 診断結果保存処理（修正対象） |
| `/prisma/schema.prisma` | データモデル（確認・修正対象） |
