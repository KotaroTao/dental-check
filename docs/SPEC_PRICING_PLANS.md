# 料金プラン変更 仕様書

## 概要

現在の単一プラン（月額3,300円）から、複数プラン体系に変更する。

---

## プラン一覧

| プラン名 | 月額料金（税別） | 月額料金（税込） | QRコード上限 | 特典 |
|----------|------------------|------------------|--------------|------|
| スターター | ¥4,980 | ¥5,478 | 2個 | - |
| スタンダード | ¥8,800 | ¥9,680 | 無制限 | - |
| マネージド | ¥29,800 | ¥32,780 | 無制限 | 担当者による分析・アドバイス |
| 無料 | ¥0 | ¥0 | 無制限 | 管理者のみ設定可能（非公開） |

---

## プラン詳細

### 1. スタータープラン（¥4,980/月）

**対象**: 小規模医院、お試し利用

**機能制限**:
- QRコード作成: **2個まで**
- 上限到達時は新規作成ボタンを非活性化
- 既存QRコードの編集・削除は可能

**表示メッセージ（上限時）**:
```
QRコードの上限（2個）に達しました。
追加作成するにはスタンダードプランへのアップグレードをご検討ください。
```

---

### 2. スタンダードプラン（¥8,800/月）

**対象**: 中規模医院、本格利用

**機能**:
- QRコード作成: **無制限**
- 全統計機能利用可能
- 全CTA機能利用可能

---

### 3. マネージドプラン（¥29,800/月）

**対象**: 大規模医院、効果を最大化したい医院

**機能**:
- スタンダードプランの全機能
- QRコード作成: **無制限**
- **担当者による分析・アドバイス**

#### マネージド特典: 分析・アドバイス内容

| カテゴリ | 内容 | 頻度 |
|----------|------|------|
| **月次レポート** | 診断数・CTA数・エリア分析のサマリーレポート | 月1回 |
| **効果分析** | QRコード別の効果比較、ベストパフォーマー特定 | 月1回 |
| **改善提案** | CTAボタンの最適化提案（文言・配置・色） | 随時 |
| **エリア戦略** | 診断実施エリアに基づくポスティング戦略 | 月1回 |
| **競合分析** | 同エリア歯科医院との比較（可能な範囲） | 四半期 |
| **季節施策** | 歯科需要の季節変動に合わせたキャンペーン提案 | 随時 |
| **個別相談** | Zoom/電話での個別コンサルティング | 月1回30分 |

#### 管理画面での表示

マネージドプラン契約医院には以下を表示:
- ダッシュボードに「マネージドプラン」バッジ
- 担当者連絡先（メール）
- 次回レポート予定日
- 過去のレポートダウンロード（将来対応）

---

### 4. 無料プラン（¥0/月）

**対象**: 特別提携医院、テスト用アカウント

**特徴**:
- 公開ページ（料金表）には**非表示**
- **管理者画面からのみ**設定可能
- 全機能利用可能（QRコード無制限）
- 決済不要

**ユースケース**:
- パートナー医院への無料提供
- デモ・営業用アカウント
- 開発・テスト用アカウント

---

## データベース変更

### Subscription テーブル

```prisma
model Subscription {
  id                   String    @id @default(uuid())
  clinicId             String    @unique @map("clinic_id")

  // プランタイプを追加
  planType             String    @default("starter") @map("plan_type")
  // starter | standard | managed | free

  payjpCustomerId      String?   @map("payjp_customer_id")
  payjpSubscriptionId  String?   @map("payjp_subscription_id")
  status               String    @default("trial")
  trialEnd             DateTime? @map("trial_end")
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  canceledAt           DateTime? @map("canceled_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}
```

### プラン定義（定数）

```typescript
// src/lib/plans.ts

export const PLANS = {
  starter: {
    id: 'starter',
    name: 'スターター',
    price: 4980,        // 税別
    priceWithTax: 5478, // 税込
    qrCodeLimit: 2,
    features: [
      'QRコード2個まで',
      '全統計機能',
      '全CTA機能',
    ],
    isPublic: true,
  },
  standard: {
    id: 'standard',
    name: 'スタンダード',
    price: 8800,
    priceWithTax: 9680,
    qrCodeLimit: null, // 無制限
    features: [
      'QRコード無制限',
      '全統計機能',
      '全CTA機能',
    ],
    isPublic: true,
  },
  managed: {
    id: 'managed',
    name: 'マネージド',
    price: 29800,
    priceWithTax: 32780,
    qrCodeLimit: null,
    features: [
      'QRコード無制限',
      '全統計機能',
      '全CTA機能',
      '月次レポート',
      '効果分析・改善提案',
      '個別コンサルティング',
    ],
    isPublic: true,
  },
  free: {
    id: 'free',
    name: '無料',
    price: 0,
    priceWithTax: 0,
    qrCodeLimit: null,
    features: [
      'QRコード無制限',
      '全統計機能',
      '全CTA機能',
    ],
    isPublic: false, // 公開ページには非表示
  },
} as const;

export type PlanType = keyof typeof PLANS;
```

---

## UI変更

### 1. 契約・お支払いページ（/dashboard/billing）

#### プラン選択UI

```
┌─────────────────────────────────────────────────────────────────┐
│ 料金プラン                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ スターター    │  │ スタンダード  │  │ マネージド    │          │
│  │              │  │  おすすめ     │  │              │          │
│  │  ¥4,980/月   │  │  ¥8,800/月   │  │ ¥29,800/月   │          │
│  │   (税別)     │  │   (税別)      │  │   (税別)     │          │
│  │              │  │              │  │              │          │
│  │ ・QRコード2個 │  │ ・QRコード   │  │ ・QRコード   │          │
│  │ ・全統計機能  │  │   無制限     │  │   無制限     │          │
│  │ ・全CTA機能   │  │ ・全統計機能  │  │ ・分析レポート│          │
│  │              │  │ ・全CTA機能   │  │ ・改善提案   │          │
│  │              │  │              │  │ ・個別相談   │          │
│  │              │  │              │  │              │          │
│  │ [現在のプラン] │  │ [アップグレード]│ │ [アップグレード]│         │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 現在のプラン表示

```
現在のプラン: スターター（¥5,478/月 税込）
QRコード: 1/2個使用中
次回請求日: 2025年1月28日
```

---

### 2. ダッシュボード（/dashboard）

#### QRコード作成ボタン（上限到達時）

**スタータープランでQRコード2個の場合**:

```
┌─────────────────────────────────────────────────────────────────┐
│ QRコード (2/2)                          [新規作成] ← グレーアウト │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ QRコードの上限に達しました                                   │
│  スタンダードプランにアップグレードすると無制限で作成できます      │
│  [プランを確認する]                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3. 管理者画面（/admin）

#### 医院詳細でプラン設定

```
┌─────────────────────────────────────────────────────────────────┐
│ 医院設定                                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ プラン: [スターター ▼]                                          │
│         ├─ スターター                                           │
│         ├─ スタンダード                                         │
│         ├─ マネージド                                           │
│         └─ 無料 ← 管理者のみ表示                                │
│                                                                  │
│ ステータス: [有効 ▼]                                            │
│                                                                  │
│ [保存]                                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## API変更

### 1. プラン情報取得

```
GET /api/billing/plans
```

**レスポンス**:
```json
{
  "plans": [
    {
      "id": "starter",
      "name": "スターター",
      "price": 4980,
      "priceWithTax": 5478,
      "qrCodeLimit": 2,
      "features": ["QRコード2個まで", "全統計機能", "全CTA機能"]
    },
    // ...
  ],
  "currentPlan": "starter"
}
```

### 2. プラン変更（アップグレード/ダウングレード）

```
POST /api/billing/change-plan
```

**リクエスト**:
```json
{
  "planType": "standard"
}
```

### 3. QRコード作成時の制限チェック

```
POST /api/channels
```

**エラーレスポンス（上限到達時）**:
```json
{
  "error": "QRコードの上限に達しました",
  "code": "QR_LIMIT_REACHED",
  "limit": 2,
  "current": 2,
  "upgradePlan": "standard"
}
```

### 4. 管理者用: プラン設定

```
PATCH /api/admin/clinics/:id
```

**リクエスト**:
```json
{
  "planType": "free"
}
```

---

## 実装ステップ

### Phase 1: データベース・基盤

1. [ ] Prisma スキーマに `planType` フィールド追加
2. [ ] マイグレーション実行（既存データは `starter` に設定）
3. [ ] `src/lib/plans.ts` 作成

### Phase 2: バックエンド

4. [ ] `/api/billing/plans` エンドポイント作成
5. [ ] `/api/billing/change-plan` エンドポイント作成
6. [ ] `/api/channels` にQRコード制限チェック追加
7. [ ] `/api/admin/clinics/:id` にプラン設定追加

### Phase 3: フロントエンド

8. [ ] `/dashboard/billing` プラン選択UI作成
9. [ ] `/dashboard` QRコード上限表示追加
10. [ ] `/admin` 医院詳細にプラン設定追加

### Phase 4: Pay.jp連携（後日）

11. [ ] Pay.jp プラン作成
12. [ ] プラン変更時のサブスクリプション更新
13. [ ] Webhook対応

---

## 確認項目

- [ ] スタータープランでQRコード3個目が作成できない
- [ ] 上限到達時に適切なメッセージが表示される
- [ ] プラン変更後、QRコード制限が即座に反映される
- [ ] 管理者が無料プランを設定できる
- [ ] 無料プランは公開ページに表示されない
- [ ] マネージドプランで担当者情報が表示される

---

## 注意事項

- 既存ユーザーは全て `starter` プランに移行
- 無料トライアル期間（14日）は全プラン共通で維持
- Pay.jp連携は別途対応（本仕様書のスコープ外）
