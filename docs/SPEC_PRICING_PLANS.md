# 料金プラン変更 仕様書

## 概要

4つのプラン体系を提供。

---

## プラン一覧

| プラン名 | 月額料金（税別） | QRコード上限 | 特典 |
|----------|------------------|--------------|------|
| スターター | ¥4,980 | 2枚 | - |
| スタンダード | ¥8,800 | 10枚 | - |
| カスタム | ¥12,800 | 無制限 | オリジナル診断作成 |
| マネージド | ¥39,800〜 | 無制限 | マーケティング業務代行 |
| 無料 | ¥0 | 無制限 | 管理者のみ設定可能（非公開） |

---

## プラン詳細

### 1. スタータープラン（¥4,980/月）

**対象**: 小規模医院、お試し利用

**機能**:
- QRコード作成: **2枚まで**
- すべての診断コンテンツを利用可能
- 診断結果の閲覧
- 詳細な分析機能
- CSVエクスポート

**表示メッセージ（上限時）**:
```
QRコードの上限（2枚）に達しました。
追加作成するにはスタンダードプランへのアップグレードをご検討ください。
```

---

### 2. スタンダードプラン（¥8,800/月）

**対象**: 中規模医院、本格利用

**機能**:
- QRコード作成: **10枚まで**
- すべての診断コンテンツを利用可能
- 診断結果の閲覧
- 詳細な分析機能
- CSVエクスポート

---

### 3. カスタムプラン（¥12,800/月）

**対象**: オリジナル診断を作成したい医院

**機能**:
- QRコード作成: **無制限**
- すべての診断コンテンツを利用可能
- 診断結果の閲覧
- 詳細な分析機能
- CSVエクスポート
- **オリジナル診断作成（無制限）**

---

### 4. マネージドプラン（¥39,800〜/月）

**対象**: マーケティング業務を丸ごとお任せしたい医院

**機能**:
- カスタムプランの内容全て
- **マーケティング業務を全て代行**
- チラシ作成・ポスティング地域の提案
- オリジナル診断作成・業者やりとり・戦略立案
- 貴院のマーケティング担当として伴走

**注意事項**:
- サポート内容・料金はお見積もり
- チラシ制作・ポスティング等の実費は別途

---

### 5. 無料プラン（¥0/月）

**対象**: 特別提携医院、テスト用アカウント

**特徴**:
- 公開ページ（料金表）には**非表示**
- **管理者画面からのみ**設定可能
- 全機能利用可能（QRコード無制限）
- 決済不要

**ユースケース**:
- パートナー医院への無料提供
- デモ・営業用アカウント
- 開発・テスト用アカウント

---

## データベース変更

### Subscription テーブル

```prisma
model Subscription {
  id                   String    @id @default(uuid())
  clinicId             String    @unique @map("clinic_id")

  // プランタイプを追加
  planType             String    @default("starter") @map("plan_type")
  // starter | standard | custom | managed | free

  payjpCustomerId      String?   @map("payjp_customer_id")
  payjpSubscriptionId  String?   @map("payjp_subscription_id")
  status               String    @default("trial")
  trialEnd             DateTime? @map("trial_end")
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  canceledAt           DateTime? @map("canceled_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}
```

### プラン定義（定数）

```typescript
// src/lib/plans.ts

export const PLANS = {
  starter: {
    type: 'starter',
    name: 'スタータープラン',
    price: 4980,
    qrCodeLimit: 2,
    description: 'お手軽に始めたい医院様向け',
    features: [
      'QRコード2枚まで作成可能',
      'すべての診断コンテンツを利用可能',
      '診断結果の閲覧',
      '詳細な分析機能',
      'CSVエクスポート',
    ],
  },
  standard: {
    type: 'standard',
    name: 'スタンダードプラン',
    price: 8800,
    qrCodeLimit: 10,
    description: '本格的に活用したい医院様向け',
    features: [
      'QRコード10枚まで作成可能',
      'すべての診断コンテンツを利用可能',
      '診断結果の閲覧',
      '詳細な分析機能',
      'CSVエクスポート',
    ],
  },
  custom: {
    type: 'custom',
    name: 'カスタムプラン',
    price: 12800,
    qrCodeLimit: null, // 無制限
    description: 'オリジナル診断を作成したい医院様向け',
    features: [
      'QRコード無制限',
      'すべての診断コンテンツを利用可能',
      '診断結果の閲覧',
      '詳細な分析機能',
      'CSVエクスポート',
      'オリジナル診断作成（無制限）',
    ],
  },
  managed: {
    type: 'managed',
    name: 'マネージドプラン',
    price: 39800,
    qrCodeLimit: null,
    description: 'マーケティング業務を丸ごとお任せ',
    features: [
      'カスタムプランの内容全て',
      'マーケティング業務を全て代行',
      'チラシ作成・ポスティング地域の提案',
      'オリジナル診断作成・業者やりとり・戦略立案',
      '貴院のマーケティング担当として伴走',
    ],
  },
  free: {
    type: 'free',
    name: '特別プラン（無料・無制限）',
    price: 0,
    qrCodeLimit: null,
    description: '管理者専用設定',
    features: [
      'QRコード無制限',
      '全機能利用可能',
      'オリジナル診断作成（無制限）',
    ],
    isAdminOnly: true, // 公開ページには非表示
  },
} as const;

export type PlanType = keyof typeof PLANS;
```

---

## UI変更

### 1. 契約・お支払いページ（/dashboard/billing）

#### プラン選択UI

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 料金プラン                                                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ スターター    │  │ スタンダード  │  │ カスタム      │  │ マネージド    │        │
│  │              │  │  おすすめ     │  │              │  │              │        │
│  │  ¥4,980/月   │  │  ¥8,800/月   │  │ ¥12,800/月   │  │ ¥39,800〜/月 │        │
│  │   (税別)     │  │   (税別)      │  │   (税別)     │  │   (税別)     │        │
│  │              │  │              │  │              │  │              │        │
│  │ ・QRコード2枚 │  │ ・QRコード   │  │ ・QRコード   │  │ ・カスタム   │        │
│  │ ・全分析機能  │  │   10枚まで   │  │   無制限     │  │   全機能含む │        │
│  │ ・CSV出力    │  │ ・全分析機能  │  │ ・オリジナル  │  │ ・マーケ代行 │        │
│  │              │  │ ・CSV出力    │  │   診断作成   │  │ ・戦略立案   │        │
│  │              │  │              │  │              │  │              │        │
│  │ [現在のプラン] │ │ [アップグレード]│ │[アップグレード]│  │ [お問い合わせ]│        │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 現在のプラン表示

```
現在のプラン: スターター（¥5,478/月 税込）
QRコード: 1/2個使用中
次回請求日: 2025年1月28日
```

---

### 2. ダッシュボード（/dashboard）

#### QRコード作成ボタン（上限到達時）

**スタータープランでQRコード2枚の場合**:

```
┌─────────────────────────────────────────────────────────────────┐
│ QRコード (2/2)                          [新規作成] ← グレーアウト │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ QRコードの上限（2枚）に達しました                            │
│  スタンダードプラン（10枚）またはカスタムプラン（無制限）への      │
│  アップグレードをご検討ください。                                │
│  [プランを確認する]                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**スタンダードプランでQRコード10枚の場合**:

```
┌─────────────────────────────────────────────────────────────────┐
│ QRコード (10/10)                        [新規作成] ← グレーアウト │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ QRコードの上限（10枚）に達しました                           │
│  カスタムプランにアップグレードすると無制限で作成できます        │
│  [プランを確認する]                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3. 管理者画面（/admin）

#### 医院詳細でプラン設定

```
┌─────────────────────────────────────────────────────────────────┐
│ 医院設定                                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ プラン: [スターター ▼]                                          │
│         ├─ スターター（¥4,980・QR 2枚）                         │
│         ├─ スタンダード（¥8,800・QR 10枚）                      │
│         ├─ カスタム（¥12,800・QR無制限・オリジナル診断）        │
│         ├─ マネージド（¥39,800〜・マーケティング代行）          │
│         └─ 無料 ← 管理者のみ表示                                │
│                                                                  │
│ ステータス: [有効 ▼]                                            │
│                                                                  │
│ [保存]                                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## API変更

### 1. プラン情報取得

```
GET /api/billing/plans
```

**レスポンス**:
```json
{
  "plans": [
    {
      "type": "starter",
      "name": "スタータープラン",
      "price": 4980,
      "qrCodeLimit": 2,
      "description": "お手軽に始めたい医院様向け",
      "features": ["QRコード2枚まで作成可能", "すべての診断コンテンツを利用可能", "診断結果の閲覧", "詳細な分析機能", "CSVエクスポート"]
    },
    {
      "type": "standard",
      "name": "スタンダードプラン",
      "price": 8800,
      "qrCodeLimit": 10,
      "description": "本格的に活用したい医院様向け",
      "features": ["QRコード10枚まで作成可能", "すべての診断コンテンツを利用可能", "診断結果の閲覧", "詳細な分析機能", "CSVエクスポート"]
    },
    {
      "type": "custom",
      "name": "カスタムプラン",
      "price": 12800,
      "qrCodeLimit": null,
      "description": "オリジナル診断を作成したい医院様向け",
      "features": ["QRコード無制限", "すべての診断コンテンツを利用可能", "診断結果の閲覧", "詳細な分析機能", "CSVエクスポート", "オリジナル診断作成（無制限）"]
    },
    {
      "type": "managed",
      "name": "マネージドプラン",
      "price": 39800,
      "qrCodeLimit": null,
      "description": "マーケティング業務を丸ごとお任せ",
      "features": ["カスタムプランの内容全て", "マーケティング業務を全て代行", "チラシ作成・ポスティング地域の提案", "オリジナル診断作成・業者やりとり・戦略立案", "貴院のマーケティング担当として伴走"]
    }
  ],
  "currentPlan": "starter"
}
```

### 2. プラン変更（アップグレード/ダウングレード）

```
POST /api/billing/change-plan
```

**リクエスト**:
```json
{
  "planType": "standard"
}
```

### 3. QRコード作成時の制限チェック

```
POST /api/channels
```

**エラーレスポンス（上限到達時）**:
```json
// スタータープラン（2枚上限）の場合
{
  "error": "QRコードの上限に達しました",
  "code": "QR_LIMIT_REACHED",
  "limit": 2,
  "current": 2,
  "upgradePlan": "standard" // または "custom"
}

// スタンダードプラン（10枚上限）の場合
{
  "error": "QRコードの上限に達しました",
  "code": "QR_LIMIT_REACHED",
  "limit": 10,
  "current": 10,
  "upgradePlan": "custom"
}
```

### 4. 管理者用: プラン設定

```
PATCH /api/admin/clinics/:id
```

**リクエスト**:
```json
{
  "planType": "free"
}
```

---

## 実装ステップ

### Phase 1: データベース・基盤

1. [ ] Prisma スキーマに `planType` フィールド追加
2. [ ] マイグレーション実行（既存データは `starter` に設定）
3. [ ] `src/lib/plans.ts` 作成

### Phase 2: バックエンド

4. [ ] `/api/billing/plans` エンドポイント作成
5. [ ] `/api/billing/change-plan` エンドポイント作成
6. [ ] `/api/channels` にQRコード制限チェック追加
7. [ ] `/api/admin/clinics/:id` にプラン設定追加

### Phase 3: フロントエンド

8. [ ] `/dashboard/billing` プラン選択UI作成
9. [ ] `/dashboard` QRコード上限表示追加
10. [ ] `/admin` 医院詳細にプラン設定追加

### Phase 4: Pay.jp連携（後日）

11. [ ] Pay.jp プラン作成
12. [ ] プラン変更時のサブスクリプション更新
13. [ ] Webhook対応

---

## 確認項目

- [ ] スタータープランでQRコード3枚目が作成できない（上限2枚）
- [ ] スタンダードプランでQRコード11枚目が作成できない（上限10枚）
- [ ] カスタム/マネージド/無料プランでQRコード無制限に作成できる
- [ ] 上限到達時に適切なメッセージが表示される
- [ ] プラン変更後、QRコード制限が即座に反映される
- [ ] 管理者が無料プランを設定できる
- [ ] 無料プランは公開ページに表示されない
- [ ] カスタム以上のプランでオリジナル診断が作成できる
- [ ] マネージドプランでマーケティング代行の説明が表示される

---

## 契約期間切れ時の動作

### ステータス

| ステータス | 説明 |
|------------|------|
| `expired` | 契約期間終了（猶予期間含む） |

### 機能制限一覧

| 機能 | 契約中 | 期間切れ |
|------|--------|----------|
| ログイン | ○ | ○ |
| 計測済みデータ閲覧 | ○ | ○ |
| CSVエクスポート | ○ | ○ |
| QRコード新規作成 | ○ | × |
| QRコード編集（名前・画像） | ○ | ○ |
| QRコード削除 | ○ | ×（復帰時のため） |
| 医院情報編集 | ○ | ○ |
| 診断機能（エンドユーザー） | ○ | ○（結果表示のみ） |
| 新規アクセスの計測 | ○ | × |
| CTAクリック計測 | ○ | × |

### 猶予期間（グレースピリオド）

- 期限切れ後 **3日間** は計測を継続
- 3日経過後に計測停止

### データ保持期間

- 契約切れ後 **90日間** データを保持
- 90日以内に再契約すれば全データ復元可能
- 90日経過後はデータ削除（要検討）

### ダッシュボード表示

#### 契約期間切れ時のアラート

```
┌─────────────────────────────────────────────────────────────────┐
│ ⚠️ 契約期間が終了しました                                        │
│                                                                  │
│ 現在、新規データの計測が停止しています。                          │
│ 契約を更新すると、すべての機能が再開されます。                    │
│                                                                  │
│ ・過去の計測データは閲覧可能です                                  │
│ ・診断機能は利用可能ですが、新規データは計測されません            │
│ ・QRコードの新規作成はできません                                  │
│                                                                  │
│                                          [契約を更新する]         │
└─────────────────────────────────────────────────────────────────┘
```

#### QRコード作成ボタン（期間切れ時）

```
┌─────────────────────────────────────────────────────────────────┐
│ QRコード                               [新規作成] ← グレーアウト  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ 契約期間が終了しているため、QRコードの新規作成はできません    │
│  [契約を更新する]                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 計測API（契約切れ時の動作）

```typescript
// /api/track/access, /api/track/complete, /api/track/cta

// 契約切れの場合
if (subscription.status === 'expired') {
  // 計測をスキップ（エラーは返さない）
  // 診断機能は正常に動作させる
  return NextResponse.json({ tracked: false });
}
```

### 実装チェックリスト

- [ ] `expired` ステータスの追加
- [ ] 猶予期間（3日）のロジック実装
- [ ] 計測API に契約チェック追加
- [ ] ダッシュボードに期間切れアラート表示
- [ ] QRコード新規作成の制限
- [ ] QRコード削除の制限

---

## トライアル期間

### 概要

| 項目 | 内容 |
|------|------|
| 期間 | 14日間 |
| 機能 | スタータープランと同等 |
| QRコード | 2個まで |
| 決済 | 不要（カード登録なしで開始可能） |

### トライアル終了時の動作

1. トライアル終了3日前にメール通知（将来対応）
2. トライアル終了後、`expired` ステータスに移行
3. ダッシュボードにプラン選択を促すアラート表示

### トライアル終了後のアラート

```
┌───────────────────────────────────────────────────────────────────────────────┐
│ 🎉 トライアル期間が終了しました                                                │
│                                                                                │
│ 引き続きご利用いただくには、プランをお選びください。                            │
│                                                                                │
│ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐                  │
│ │ スターター  │ │スタンダード │ │ カスタム    │ │ マネージド  │                  │
│ │ ¥4,980/月  │ │ ¥8,800/月  │ │ ¥12,800/月 │ │ ¥39,800〜/月│                  │
│ │ QRコード2枚 │ │ 10枚まで   │ │  無制限    │ │  無制限    │                  │
│ │            │ │            │ │+オリジナル │ │+マーケ代行 │                  │
│ │  [選択]    │ │  [選択]    │ │  [選択]    │ │[お問い合わせ]│                  │
│ └────────────┘ └────────────┘ └────────────┘ └────────────┘                  │
│                                                                                │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 注意事項

- 既存トライアルユーザーはそのまま継続
- 既存有料ユーザーはいない（新規プラン体系でスタート）
- Pay.jp連携は別途対応（本仕様書のスコープ外）
- 無料プランは `expired` ステータスにならない
