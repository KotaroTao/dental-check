# 歯科簡易診断WEBサービス 仕様書

## 1. プロジェクト概要

### 1.1 サービス名
**DentalCheck（デンタルチェック）**

### 1.2 サービス概要
選択式の簡単な質問に答えることで、お口の健康状態や矯正の必要性などを簡易診断できるWEBサービス。歯科医院はQRコードをチラシやホームページに掲載し、診断結果画面で予約フォームやSNSへの誘導を自由にカスタマイズできる。

### 1.3 ターゲットユーザー

#### エンドユーザー（診断を受ける人）
- お口の健康が気になる一般の方
- 子供の歯並び・矯正タイミングが気になる保護者
- 歯医者に行くべきか迷っている方

#### 管理者ユーザー（歯科医院）
- 集患・マーケティングに活用したい歯科医院
- チラシやホームページでの集患を強化したい歯科医院

### 1.4 主な目的
1. 一般の人の関心を惹き、歯科医院への受診を促す
2. QRコードを活用したオフライン→オンライン導線の構築
3. 歯科医院が手軽に使える集患ツールを提供

### 1.5 ビジネスモデル
- **月額料金**: 3,000円（税抜）/ 3,300円（税込）
- **無料トライアル**: 14日間
- **決済**: Pay.jp による自動継続課金
- **デモ版**: 無料（登録不要で診断体験可能）

---

## 2. 機能要件

### 2.0 デモ版機能

#### 2.0.1 概要
登録・課金なしで診断を体験できる無料デモ版。一般ユーザーが気軽に試せると同時に、歯科医院への営業ツールとしても活用。

#### 2.0.2 デモ版の特徴

| 項目 | 内容 |
|------|------|
| 利用対象 | 誰でも（登録不要） |
| 利用可能な診断 | すべての診断タイプ |
| 診断フロー | 通常版と同じ |
| 結果表示 | 通常版と同じ |

#### 2.0.3 デモ版と通常版の違い

| 機能 | デモ版 | 通常版（医院契約） |
|------|--------|-------------------|
| 診断の実施 | ○ | ○ |
| 結果の表示 | ○ | ○ |
| 結果のシェア | ○ | ○ |
| 医院カスタマイズCTA | × | ○ |
| 医院紹介ページ | × | ○ |
| QRコード発行 | × | ○ |
| 統計・アクセス計測 | × | ○ |
| 埋め込みコード | × | ○ |

#### 2.0.4 デモ版の結果画面

CTAエリアには以下を表示：

```
┌─────────────────────────────────────┐
│  🏥 この診断を医院で活用しませんか？ │
│                                     │
│  チラシやホームページに設置して     │
│  集患につなげることができます       │
│                                     │
│  ✓ 14日間無料でお試し              │
│  ✓ 月額3,000円（税抜）             │
│  ✓ QRコード発行・統計機能付き      │
│                                     │
│  [▶ 医院として登録する]             │
└─────────────────────────────────────┘
```

#### 2.0.5 デモ版のURL構造

| 画面 | URL |
|------|-----|
| デモ診断選択 | /demo |
| デモ診断実施 | /demo/:diagnosisType |
| デモ結果画面 | /demo/:diagnosisType/result/:id |

#### 2.0.6 デモ版の活用シーン

**一般ユーザー向け**
- サービスの体験
- お口の健康チェック
- 歯科医院に行くきっかけ作り

**歯科医院向け（営業ツール）**
- 導入前のサービス体験
- 患者への説明時のデモンストレーション
- 営業資料としての活用

### 2.1 診断機能

#### 2.1.1 診断の種類（初期リリース）

| 診断名 | 対象 | 質問数 | 所要時間 |
|--------|------|--------|----------|
| お口年齢診断 | 成人全般 | 10問 | 約2分 |
| 子供の矯正タイミングチェック | 保護者（子供：3〜12歳） | 10問 | 約2分 |

※診断コンテンツは運営側で随時追加可能な設計とする

#### 2.1.2 診断フロー
```
[QRコード読み取り] → [プロフィール入力] → [質問画面(1〜10問)] → [結果画面] → [医院紹介/CTA]
```

#### 2.1.3 プロフィール入力（診断開始前）
- **年齢**: 必須（数値入力 or 年代選択）
- **性別**: 任意（男性/女性/回答しない）
- 結果のパーソナライズと統計分析に活用

#### 2.1.4 質問形式
- **単一選択式**: 1つの選択肢を選ぶ

#### 2.1.5 結果算出ロジック
- 各回答に点数を設定（重み付け可能）
- 合計点数に基づいて結果カテゴリを判定
- カテゴリごとにメッセージとアドバイスを表示
- 年齢を考慮したパーソナライズ（「同年代の平均より...」等）

### 2.2 結果画面機能

#### 2.2.1 結果表示要素
- **診断結果タイトル**（例：「あなたのお口年齢は○○歳です」）
- **結果サマリー**（アイコン等で視覚化）
- **詳細アドバイス**（改善ポイント等）
- **注意事項**（医療診断ではない旨の免責）

#### 2.2.2 医院カスタマイズエリア（CTA）
歯科医院が自由に設定可能：

| 項目 | 説明 |
|------|------|
| 見出しテキスト | 「ご予約・ご相談はこちら」等 |
| 院長コメント | 院長からのメッセージ（任意） |
| 予約ボタン | WEB予約システムへのリンク |
| 電話ボタン | タップで電話発信 |
| LINEボタン | LINE公式アカウントへの誘導 |
| Instagram | Instagramアカウントへのリンク |
| その他SNS | Facebook、X等 |
| 医院紹介ページへのリンク | 詳細情報ページへ誘導 |

#### 2.2.3 シェア機能
- X（Twitter）シェア
- LINEシェア
- URLコピー

#### 2.2.4 OGP画像自動生成
- SNSシェア時に表示される画像を自動生成
- 診断結果（例：お口年齢42歳）を含む
- 医院ロゴを表示（設定されている場合）

### 2.3 医院紹介ミニページ

診断結果から遷移できる医院紹介ページ：

| 項目 | 必須/任意 |
|------|-----------|
| 医院名 | 必須 |
| 医院写真（外観/内観） | 任意（複数可） |
| 院長写真 | 任意 |
| 院長プロフィール | 任意 |
| 診療時間 | 任意 |
| 休診日 | 任意 |
| アクセス・住所 | 任意 |
| Googleマップ埋め込み | 任意 |
| 電話番号 | 任意 |
| 予約リンク | 任意 |

### 2.4 QRコード機能

#### 2.4.1 QRコード発行
- 診断タイプごとにQRコードを発行
- 医院固有のURLをエンコード
- ダウンロード形式：PNG、SVG
- サイズ選択：S/M/L（印刷用途に対応）

#### 2.4.2 活用シーン
- チラシ・ポスター
- 名刺
- ホームページ
- 院内POP
- SNS投稿

#### 2.4.3 アクセス計測
各診断コンテンツごとに記録：
- QRコード読み取り（アクセス）回数
- アクセス日時
- 診断完了数
- CTAクリック数（予約ボタン、電話、LINE等）

### 2.5 埋め込み機能

#### 2.5.1 埋め込み形式
| 形式 | 説明 |
|------|------|
| iframe（フルページ） | ページ内に診断画面を埋め込み |
| ポップアップ/モーダル | ボタンクリックで診断を開始 |
| リンクボタン | 「診断を始める」ボタンのみ設置 |

#### 2.5.2 発行物
- 埋め込みコード（HTML）
- 直接リンクURL
- QRコード画像

### 2.6 医院管理機能

#### 2.6.1 アカウント管理
- 医院アカウント登録（メール認証）
- ログイン/ログアウト
- パスワード変更・リセット
- 医院基本情報の編集

#### 2.6.2 診断設定
- 使用する診断の有効/無効切り替え
- 結果画面のCTAエリア編集
- 医院ロゴのアップロード
- メインカラーの設定（1色）

#### 2.6.3 医院紹介ページ編集
- 各項目の入力・編集
- 画像のアップロード
- プレビュー機能

#### 2.6.4 統計ダッシュボード
シンプルな数値表示：
- QRコード読み取り数（日別/月別）
- 診断完了数
- CTAクリック数（種類別）
- 診断完了率

#### 2.6.5 QRコード・埋め込みコード発行
- 診断タイプ選択
- QRコードダウンロード
- 埋め込みコードコピー

### 2.7 サブスクリプション・決済機能

#### 2.7.1 料金プラン
- **月額**: 3,000円（税抜）
- **無料トライアル**: 14日間（クレジットカード登録必要）

#### 2.7.2 Pay.jp連携
- クレジットカード登録
- 自動継続課金（毎月同日）
- 課金履歴の確認
- カード情報の変更
- 解約手続き

#### 2.7.3 トライアル管理
- トライアル開始日の記録
- トライアル終了3日前にリマインドメール
- トライアル終了後、自動で有料プランへ移行
- 解約した場合はトライアル終了で利用停止

#### 2.7.4 アカウント状態
| 状態 | 説明 |
|------|------|
| trial | 無料トライアル中 |
| active | 有料契約中 |
| past_due | 支払い遅延（リトライ中、機能は利用可能） |
| canceled | ユーザーによる解約済み（期間終了まで利用可能） |
| suspended | 支払い失敗による利用停止（機能利用不可） |

---

## 3. 診断コンテンツ詳細設計

### 3.1 お口年齢診断

#### 対象
成人全般（20歳以上推奨）

#### 質問一覧

| No | 質問 | 選択肢 | スコア |
|----|------|--------|--------|
| 1 | 1日の歯磨き回数は？ | 0回/1回/2回/3回以上 | 0/5/10/10 |
| 2 | 歯間ブラシやフロスを使っていますか？ | 使っていない/たまに/毎日 | 0/5/10 |
| 3 | 定期的に歯科検診を受けていますか？ | 受けていない/年1回程度/半年に1回以上 | 0/5/10 |
| 4 | 歯茎から出血することがありますか？ | よくある/たまにある/ほとんどない | 0/5/10 |
| 5 | 口臭が気になることはありますか？ | よくある/たまにある/ほとんどない | 0/5/10 |
| 6 | 冷たいものや熱いものがしみますか？ | よくある/たまにある/ほとんどない | 0/5/10 |
| 7 | 歯がグラグラする感じはありますか？ | ある/少しある/ない | 0/5/10 |
| 8 | 喫煙習慣はありますか？ | 吸う/以前吸っていた/吸わない | 0/5/10 |
| 9 | 甘い飲み物やお菓子をよく摂りますか？ | よく摂る/たまに/あまり摂らない | 0/5/10 |
| 10 | 最後に歯科医院に行ったのはいつですか？ | 1年以上前/半年〜1年前/半年以内 | 0/5/10 |

#### 結果パターン

| スコア範囲 | お口年齢 | カテゴリ | メッセージ |
|------------|----------|----------|------------|
| 0-30 | 実年齢+15歳 | 要注意 | お口の健康に赤信号です。すぐに歯科医院での検診をおすすめします。 |
| 31-50 | 実年齢+10歳 | 注意 | お口のケアに改善の余地があります。定期検診を受けてみましょう。 |
| 51-70 | 実年齢+5歳 | やや注意 | まずまずのケアができていますが、もう少し意識を高めましょう。 |
| 71-85 | 実年齢相当 | 良好 | 良いケアができています。この調子で続けましょう。 |
| 86-100 | 実年齢-5歳 | 優秀 | 素晴らしいお口のケアです！定期検診で維持していきましょう。 |

---

### 3.2 子供の矯正タイミングチェック

#### 対象
お子さん（3〜12歳）をお持ちの保護者

#### 質問一覧

| No | 質問 | 選択肢 | スコア |
|----|------|--------|--------|
| 1 | お子さんの年齢は？ | 3〜5歳/6〜8歳/9〜12歳 | 情報収集 |
| 2 | 指しゃぶりや爪を噛む癖がありますか（ありましたか）？ | 現在もある/以前あった/ない | 10/5/0 |
| 3 | 口呼吸をしていることが多いですか？ | はい/時々/いいえ | 10/5/0 |
| 4 | 乳歯の生え変わりは順調ですか？ | 遅い気がする/普通/早い気がする | 5/0/5 |
| 5 | 歯並びで気になる点はありますか？ | とても気になる/少し気になる/特にない | 10/5/0 |
| 6 | 食べ物を噛むとき、片側だけで噛んでいませんか？ | はい/時々/いいえ | 10/5/0 |
| 7 | 発音で気になる点はありますか？ | ある/少しある/ない | 10/5/0 |
| 8 | 顔の左右で非対称な部分がありますか？ | 気になる/少し気になる/気にならない | 10/5/0 |
| 9 | ご家族に歯並びの悪い方はいますか？ | いる/わからない/いない | 10/5/0 |
| 10 | 以前、歯科医院で歯並びについて指摘を受けたことはありますか？ | ある/覚えていない/ない | 10/5/0 |

#### 結果パターン

| スコア範囲 | カテゴリ | タイトル | メッセージ |
|------------|----------|----------|------------|
| 0-20 | 様子見 | 今すぐの矯正は不要かもしれません | 現時点では大きな問題は見られません。ただし、成長とともに変化することがありますので、定期的なチェックをおすすめします。 |
| 21-45 | 相談推奨 | 一度専門家に相談してみましょう | いくつか気になるポイントがあります。矯正専門医への相談をおすすめします。早期発見が治療の選択肢を広げます。 |
| 46-70 | 早期相談 | 早めの相談をおすすめします | 矯正治療の検討をおすすめする兆候が見られます。お子さんの成長段階に合わせた最適な治療タイミングを相談しましょう。 |
| 71-100 | 至急相談 | できるだけ早く専門医へ | 複数の気になる兆候があります。早期に矯正専門医の診察を受けることを強くおすすめします。 |

---

## 4. 画面設計・UI/UX仕様

### 4.1 画面一覧

| 画面名 | URL例 | 説明 |
|--------|-------|------|
| トップページ | / | サービス紹介、医院向けLP |
| **デモ版** | | |
| デモ診断選択 | /demo | デモ版の診断一覧 |
| デモ診断実施 | /demo/:diagnosisType | デモ版の診断画面 |
| デモ結果画面 | /demo/:diagnosisType/result/:id | デモ版の結果画面 |
| **通常版（医院経由）** | | |
| 診断プロフィール入力 | /d/:clinicSlug/:diagnosisType | 年齢等の入力 |
| 診断実施画面 | /d/:clinicSlug/:diagnosisType/q/:step | 質問に回答 |
| 結果画面 | /d/:clinicSlug/:diagnosisType/result/:id | 診断結果とCTA |
| 医院紹介ページ | /c/:clinicSlug | 医院の詳細情報 |
| **医院管理画面** | | |
| 医院登録 | /signup | 新規登録 |
| 医院ログイン | /login | ログイン |
| ダッシュボード | /dashboard | 統計トップ |
| CTA設定 | /dashboard/cta | 結果画面カスタマイズ |
| 医院情報編集 | /dashboard/clinic | 医院紹介ページ編集 |
| QRコード発行 | /dashboard/qr | QRコード・埋め込みコード |
| 契約・支払い | /dashboard/billing | サブスクリプション管理 |

### 4.2 診断実施画面 UI仕様

```
┌─────────────────────────────────────────────┐
│  [医院ロゴ]        お口年齢診断             │
├─────────────────────────────────────────────┤
│                                             │
│   ━━━━━━━━━━●━━━━━━━━━━  (5/10)            │
│                                             │
│   Q5. 口臭が気になることはありますか？      │
│                                             │
│   ┌─────────────────────────────────┐       │
│   │  ○  よくある                    │       │
│   └─────────────────────────────────┘       │
│   ┌─────────────────────────────────┐       │
│   │  ○  たまにある                  │       │
│   └─────────────────────────────────┘       │
│   ┌─────────────────────────────────┐       │
│   │  ○  ほとんどない                │       │
│   └─────────────────────────────────┘       │
│                                             │
│   [← 戻る]              [次へ →]            │
│                                             │
└─────────────────────────────────────────────┘
```

#### UI要件
- **プログレスバー**: 進捗を視覚的に表示
- **質問番号**: 現在の質問/全質問数を表示
- **選択肢**: タップしやすい大きなボタン形式
- **ナビゲーション**: 戻る・次へボタン（次へは選択後に有効化）
- **アニメーション**: 画面遷移時にスムーズなアニメーション

### 4.3 結果画面 UI仕様

```
┌─────────────────────────────────────────────┐
│  [医院ロゴ]        診断結果                 │
├─────────────────────────────────────────────┤
│                                             │
│         🦷 あなたのお口年齢は               │
│                                             │
│              【 42歳 】                     │
│         （実年齢35歳より+7歳）              │
│                                             │
│   同年代の平均より少し高めです              │
│                                             │
│   📝 アドバイス                             │
│   歯磨きの回数や歯間ケアに改善の            │
│   余地があります。定期検診も...             │
│                                             │
├─────────────────────────────────────────────┤
│  【医院カスタマイズエリア】                 │
│  ┌─────────────────────────────────────┐   │
│  │  🏥 ○○歯科クリニック                 │   │
│  │                                       │   │
│  │  👨‍⚕️ 院長より                         │   │
│  │  「気になる結果が出た方は             │   │
│  │   お気軽にご相談ください」            │   │
│  │                                       │   │
│  │  [📞 電話予約] [📱 LINE]              │   │
│  │  [🗓️ WEB予約] [📷 Instagram]          │   │
│  │                                       │   │
│  │  [▶ 医院について詳しく見る]           │   │
│  └─────────────────────────────────────┘   │
├─────────────────────────────────────────────┤
│                                             │
│   結果をシェア: [X] [LINE] [📋コピー]       │
│                                             │
│   ※この診断は医療診断ではありません        │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.4 レスポンシブ対応

| デバイス | 画面幅 | 対応方針 |
|----------|--------|----------|
| スマートフォン | 〜767px | メイン対応（縦スクロール基本） |
| タブレット | 768px〜1023px | スマホレイアウトを拡大 |
| PC | 1024px〜 | 中央寄せ、最大幅480px |

※主要ターゲットはスマートフォン（QRコード読み取り）

### 4.5 アクセシビリティ対応

- キーボードナビゲーション対応
- スクリーンリーダー対応（aria-label等）
- 十分な色コントラスト比
- フォーカス状態の明確な表示

---

## 5. 技術仕様

### 5.1 技術スタック

#### フロントエンド
| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js 14 (App Router) |
| 言語 | TypeScript |
| スタイリング | Tailwind CSS |
| UIコンポーネント | shadcn/ui |
| 状態管理 | Zustand |
| フォーム | React Hook Form + Zod |
| アニメーション | Framer Motion |

#### バックエンド
| 項目 | 技術 |
|------|------|
| ランタイム | Node.js |
| フレームワーク | Next.js API Routes |
| ORM | Prisma |
| 認証 | NextAuth.js |
| バリデーション | Zod |
| 決済 | Pay.jp |
| メール | Resend |

#### インフラ・データベース
| 項目 | 技術 |
|------|------|
| ホスティング | Vercel |
| データベース | PostgreSQL (Supabase or Neon) |
| ファイルストレージ | Cloudflare R2 or Vercel Blob |
| OGP画像生成 | Vercel OG (@vercel/og) |
| QRコード生成 | qrcode (npm) |

### 5.2 API設計

#### デモ版API

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/demo/diagnosis | デモ版診断一覧取得 |
| GET | /api/demo/:type | デモ版診断情報・質問取得 |
| POST | /api/demo/:type/start | デモ版診断開始 |
| POST | /api/demo/:type/submit | デモ版診断結果送信 |
| GET | /api/demo/result/:id | デモ版結果取得 |

#### エンドユーザー向けAPI（医院経由）

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/c/:clinicSlug | 医院情報取得 |
| GET | /api/d/:clinicSlug/:type | 診断情報・質問取得 |
| POST | /api/d/:clinicSlug/:type/start | 診断開始（プロフィール送信） |
| POST | /api/d/:clinicSlug/:type/submit | 診断結果送信 |
| GET | /api/result/:id | 結果取得 |
| POST | /api/track/cta | CTAクリック記録 |

#### 医院管理者向けAPI

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| POST | /api/auth/signup | 新規登録 |
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| POST | /api/auth/reset-password | パスワードリセット |
| GET | /api/clinic/profile | 医院情報取得 |
| PUT | /api/clinic/profile | 医院情報更新 |
| POST | /api/clinic/logo | ロゴアップロード |
| GET | /api/clinic/cta | CTA設定取得 |
| PUT | /api/clinic/cta | CTA設定更新 |
| GET | /api/clinic/page | 医院紹介ページ取得 |
| PUT | /api/clinic/page | 医院紹介ページ更新 |
| GET | /api/clinic/stats | 統計取得 |
| GET | /api/clinic/stats/daily | 日別統計 |
| GET | /api/clinic/qr/:type | QRコード生成 |
| GET | /api/clinic/embed/:type | 埋め込みコード取得 |

#### 決済API（Pay.jp連携）

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| POST | /api/billing/card | カード登録・更新 |
| DELETE | /api/billing/card | カード削除 |
| GET | /api/billing/subscription | 契約情報取得 |
| POST | /api/billing/subscribe | 有料プラン開始 |
| POST | /api/billing/cancel | 解約 |
| GET | /api/billing/invoices | 請求履歴 |
| POST | /api/webhook/payjp | Pay.jp Webhook |

### 5.3 セキュリティ要件

- HTTPS必須
- CSRF対策（Next.js標準）
- XSS対策（エスケープ処理）
- SQLインジェクション対策（Prismaによるパラメータ化）
- レート制限（API呼び出し制限）
- 入力値バリデーション（Zod）
- 認証トークンの安全な管理（HttpOnly Cookie）
- Pay.jp Webhookの署名検証

---

## 6. データ構造

### 6.1 ER図

```
┌───────────────┐       ┌───────────────┐
│    Clinic     │       │  Subscription │
├───────────────┤       ├───────────────┤
│ id            │───────│ id            │
│ name          │       │ clinic_id(FK) │
│ slug          │       │ status        │
│ email         │       │ payjp_sub_id  │
│ password_hash │       │ current_period│
│ phone         │       │ trial_end     │
│ logo_url      │       │ canceled_at   │
│ main_color    │       └───────────────┘
│ cta_config    │
│ clinic_page   │       ┌───────────────┐
│ status        │       │  DiagnosisType│
│ created_at    │       ├───────────────┤
└───────────────┘       │ id            │
       │                │ name          │
       │                │ slug          │
       │                │ description   │
       ▼                │ questions(JSON│
┌───────────────────┐   │ results (JSON)│
│  ClinicDiagnosis  │   │ is_active     │
├───────────────────┤   └───────────────┘
│ id                │          │
│ clinic_id (FK)    │          │
│ diagnosis_type_id │◄─────────┘
│ is_enabled        │
│ created_at        │
└───────────────────┘
       │
       ▼
┌───────────────────┐    ┌───────────────┐
│  DiagnosisSession │    │   AccessLog   │
├───────────────────┤    ├───────────────┤
│ id                │    │ id            │
│ clinic_id         │    │ clinic_id     │
│ diagnosis_type_id │    │ diagnosis_type│
│ user_age          │    │ event_type    │
│ user_gender       │    │ created_at    │
│ answers (JSON)    │    └───────────────┘
│ total_score       │
│ result_category   │    ┌───────────────┐
│ completed_at      │    │   CTAClick    │
│ created_at        │    ├───────────────┤
└───────────────────┘    │ id            │
                         │ session_id    │
                         │ cta_type      │
                         │ created_at    │
                         └───────────────┘
```

### 6.2 主要テーブル定義

#### Clinic（医院）
```sql
CREATE TABLE clinics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(100) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  phone VARCHAR(20),
  logo_url VARCHAR(500),
  main_color VARCHAR(7) DEFAULT '#2563eb',

  -- CTA設定（JSON）
  cta_config JSONB DEFAULT '{}',

  -- 医院紹介ページ（JSON）
  clinic_page JSONB DEFAULT '{}',

  -- アカウント状態
  status VARCHAR(20) DEFAULT 'trial',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Subscription（サブスクリプション）
```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinic_id UUID REFERENCES clinics(id) UNIQUE,

  -- Pay.jp情報
  payjp_customer_id VARCHAR(100),
  payjp_subscription_id VARCHAR(100),

  -- 状態
  status VARCHAR(20) DEFAULT 'trial',

  -- 期間
  trial_end TIMESTAMP,
  current_period_start TIMESTAMP,
  current_period_end TIMESTAMP,
  canceled_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### DiagnosisType（診断タイプ）
```sql
CREATE TABLE diagnosis_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(100) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,

  -- 質問データ（JSON配列）
  questions JSONB NOT NULL,

  -- 結果パターン（JSON配列）
  result_patterns JSONB NOT NULL,

  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### DiagnosisSession（診断セッション）
```sql
CREATE TABLE diagnosis_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinic_id UUID REFERENCES clinics(id),
  diagnosis_type_id UUID REFERENCES diagnosis_types(id),

  -- デモ版フラグ
  is_demo BOOLEAN DEFAULT false,

  -- ユーザー情報
  user_age INTEGER,
  user_gender VARCHAR(10),

  -- 回答・結果
  answers JSONB,
  total_score INTEGER,
  result_category VARCHAR(50),

  -- 完了フラグ
  completed_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### AccessLog（アクセスログ）
```sql
CREATE TABLE access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinic_id UUID REFERENCES clinics(id),
  diagnosis_type_slug VARCHAR(100),

  -- イベント種別: 'qr_scan', 'page_view', 'diagnosis_start', 'diagnosis_complete'
  event_type VARCHAR(50) NOT NULL,

  -- 追加情報
  user_agent TEXT,
  referer TEXT,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス
CREATE INDEX idx_access_logs_clinic_date ON access_logs(clinic_id, created_at);
```

#### CTAClick（CTAクリック記録）
```sql
CREATE TABLE cta_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES diagnosis_sessions(id),
  clinic_id UUID REFERENCES clinics(id),

  -- クリック種別: 'phone', 'line', 'reservation', 'instagram', 'clinic_page'
  cta_type VARCHAR(50) NOT NULL,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス
CREATE INDEX idx_cta_clicks_clinic_date ON cta_clicks(clinic_id, created_at);
```

### 6.3 CTA設定JSON構造

```json
{
  "heading": "ご予約・ご相談はこちら",
  "director_comment": "気になる結果が出た方はお気軽にご相談ください。",
  "buttons": [
    {
      "type": "phone",
      "label": "電話予約",
      "value": "03-1234-5678",
      "enabled": true
    },
    {
      "type": "line",
      "label": "LINE予約",
      "value": "https://line.me/R/ti/p/@xxxxx",
      "enabled": true
    },
    {
      "type": "reservation",
      "label": "WEB予約",
      "value": "https://example.com/reserve",
      "enabled": true
    },
    {
      "type": "instagram",
      "label": "Instagram",
      "value": "https://instagram.com/xxxxx",
      "enabled": false
    }
  ],
  "show_clinic_link": true
}
```

### 6.4 医院紹介ページJSON構造

```json
{
  "photos": [
    {"url": "https://...", "caption": "外観"},
    {"url": "https://...", "caption": "診察室"}
  ],
  "director": {
    "name": "山田 太郎",
    "photo_url": "https://...",
    "profile": "○○大学歯学部卒業。..."
  },
  "hours": {
    "weekday": "9:00-18:00",
    "saturday": "9:00-13:00",
    "sunday": "休診",
    "note": "祝日休診"
  },
  "access": {
    "address": "東京都○○区...",
    "map_embed": "<iframe>...</iframe>",
    "note": "○○駅徒歩5分"
  }
}
```

---

## 7. 非機能要件

### 7.1 パフォーマンス

| 項目 | 目標値 |
|------|--------|
| ページ読み込み時間（LCP） | 2.5秒以内 |
| 操作応答時間（FID） | 100ms以内 |
| API応答時間 | 300ms以内（95パーセンタイル） |

### 7.2 可用性

| 項目 | 目標値 |
|------|--------|
| 稼働率 | 99.5%以上 |
| 障害復旧時間 | 4時間以内 |

### 7.3 スケーラビリティ

| 項目 | 初期想定 |
|------|----------|
| 登録医院数 | 〜100 |
| 日間診断数 | 〜1,000 |

### 7.4 対応ブラウザ

| ブラウザ | バージョン |
|----------|------------|
| Chrome | 最新2バージョン |
| Safari | 最新2バージョン |
| Edge | 最新2バージョン |
| iOS Safari | iOS 14以上 |
| Android Chrome | Android 10以上 |

---

## 8. 開発フェーズ

### Phase 1: MVP（最小実用版）
- [ ] プロジェクトセットアップ（Next.js, Prisma, DB）
- [ ] デモ版診断機能（お口年齢診断）
- [ ] プロフィール入力画面
- [ ] 結果画面（デモ版）
- [ ] デモ版結果画面のCTA（医院登録誘導）
- [ ] 医院経由の診断機能
- [ ] QRコード発行
- [ ] アクセス計測（基本）

### Phase 2: 医院管理機能
- [ ] 医院登録・認証
- [ ] ダッシュボード
- [ ] CTA設定機能
- [ ] 医院紹介ページ編集
- [ ] 統計表示

### Phase 3: 決済・サブスク
- [ ] Pay.jp連携
- [ ] サブスクリプション管理
- [ ] トライアル機能
- [ ] 請求・解約フロー

### Phase 4: 機能拡充
- [ ] 子供の矯正タイミングチェック
- [ ] OGP画像生成
- [ ] シェア機能
- [ ] 埋め込み形式選択
- [ ] CTAクリック計測

---

## 9. 免責事項・法的考慮

### 9.1 免責表示（必須）

診断結果画面に以下の文言を必ず表示：

> ※この診断は医療行為ではありません。実際の診断・治療については、必ず歯科医師にご相談ください。

### 9.2 プライバシーポリシー

- 収集する情報（年齢、性別、診断回答、アクセスログ等）
- 利用目的（サービス提供、統計分析）
- 第三者提供の有無
- Cookie使用について

### 9.3 利用規約

- サービス内容
- 禁止事項
- 免責事項
- 料金・支払い条件
- 解約条件

### 9.4 特定商取引法に基づく表記

月額課金サービスのため必須

---

## 10. 将来の拡張案（参考）

※初期リリースには含めない

- 歯周病リスクチェック（診断追加）
- ホワイトニング適性診断（診断追加）
- 子供の虫歯リスクチェック（診断追加）
- 顎関節症リスクチェック（診断追加）
- 複数スタッフアカウント対応
- CSVエクスポート機能
- LINE通知連携

---

**ドキュメントバージョン**: 2.2
**最終更新日**: 2024年1月
**作成者**: DentalCheck開発チーム
